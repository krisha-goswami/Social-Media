<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Media - Functional</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles to override Tailwind and add Instagram specific details */
        :root {
            --primary-text: #262626;
            --secondary-text: #8e8e8e;
            --border-color: #dbdbdb;
            --link-blue: #0095f6;
            --background-color: #fafafa;
            --white: #ffffff;
            --story-gradient: radial-gradient(circle at 30% 107%, #fdf497 0%, #fdf497 5%, #fd5949 45%, #d6249f 60%, #285AEB 90%);
        }
        .dark {
            --primary-text: #ffffff;
            --secondary-text: #a8a8a8;
            --border-color: #363636;
            --background-color: #121212;
            --white: #1e1e1e;
        }

        /* Set Inter font */
        html { font-family: "Inter", sans-serif; }

        /* Main app layout */
        .app-container {
            display: flex;
            min-height: 100vh;
            background-color: var(--background-color);
        }
        .dark .app-container {
            background-color: var(--background-color);
        }

        /* Desktop Sidebar Styles (Fixed for large screens) */
        .sidebar {
            width: 240px;
            height: 100vh;
            border-right: 1px solid var(--border-color);
            background-color: var(--white);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 50;
            color: var(--primary-text);
        }
        .dark .sidebar {
            background-color: var(--white);
            border-right-color: var(--border-color);
        }

        .main-content-area {
            flex-grow: 1;
            margin-left: 240px; /* Offset for sidebar */
            display: flex;
            justify-content: center;
            padding-top: 50px; /* Space for fixed header/nav on mobile */
        }

        /* Feed Layout */
        .content-view {
            width: 100%;
            max-width: 900px; /* Wider view for profile/messages */
            padding-top: 20px;
            color: var(--primary-text);
        }
        .feed-wrapper {
            max-width: 470px;
            width: 100%;
        }

        /* Post Card Styling */
        .post-card {
            border: 1px solid var(--border-color);
            background-color: var(--white);
            border-radius: 8px;
            margin-bottom: 24px;
        }
        .dark .post-card {
            border-color: var(--border-color);
            background-color: var(--white);
        }

        .post-image {
            width: 100%;
            aspect-ratio: 1 / 1;
            object-fit: cover;
        }

        /* Story Circle Styles */
        .story-circle-border {
            padding: 2px;
            background-image: var(--story-gradient);
            border-radius: 50%;
            background-clip: content-box;
            background-origin: border-box;
            margin-bottom: 4px;
            cursor: pointer;
        }
        .story-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #ccc;
            border: 2px solid white;
            background-size: cover;
            background-position: center;
        }
        .dark .story-circle {
             border: 2px solid var(--white);
        }

        /* Profile Tab Styling */
        .profile-tab-button {
            border-bottom: 2px solid transparent;
            color: var(--secondary-text);
        }
        .profile-tab-button.active {
            border-bottom: 2px solid var(--primary-text);
            color: var(--primary-text);
            font-weight: 700;
        }

        /* Mobile Fixed Navigation */
        @media (max-width: 1024px) {
            .sidebar {
                display: none;
            }
            .main-content-area {
                margin-left: 0;
            }
            .mobile-nav {
                display: flex !important;
            }
            .content-view {
                padding-top: 0;
            }
        }
        
        /* Desktop specific adjustments */
        @media (min-width: 1025px) {
            .mobile-nav {
                display: none;
            }
        }

        /* Modal specific styles */
        .modal-overlay {
            z-index: 100;
        }
        .modal-content {
            z-index: 101;
            max-width: 500px;
            animation: modalFadeIn 0.2s ease-out;
            background-color: var(--white);
            color: var(--primary-text);
        }
        .dark .modal-content {
            background-color: var(--white);
            color: var(--primary-text);
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        /* Tailwind Toggle Switch styles */
        .toggle-switch input:checked + .slider {
            background-color: #0095f6;
        }
        .toggle-switch input:checked + .slider:before {
            transform: translateX(20px);
            background-color: var(--white);
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Settings/Privacy Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center modal-overlay" onclick="closeModal('settings-modal')">
        <div id="settings-modal-content" class="bg-white p-6 rounded-xl shadow-2xl modal-content" onclick="event.stopPropagation()">
            <!-- Dynamic content loaded here -->
        </div>
    </div>
    
    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center modal-overlay" onclick="closeModal('edit-profile-modal')">
        <div class="bg-white rounded-xl shadow-2xl modal-content w-full m-4" onclick="event.stopPropagation()">
            <header class="flex items-center justify-between p-4 border-b border-gray-200">
                <button onclick="closeModal('edit-profile-modal')" class="text-gray-500 hover:text-gray-700"><i data-lucide="x" class="w-6 h-6"></i></button>
                <h3 class="text-xl font-bold">Edit Profile</h3>
                <button onclick="saveProfileChanges()" class="text-blue-500 font-bold hover:text-blue-700">Done</button>
            </header>
            <div class="p-6 space-y-6">
                <!-- Profile Image -->
                <div class="flex flex-col items-center">
                    <div id="profile-img-preview" class="w-24 h-24 rounded-full border-2 border-gray-300 mb-2 cursor-pointer" style="background-image: url('https://i.pravatar.cc/150?img=47'); background-size: cover;"></div>
                    <button class="text-blue-500 font-bold text-sm hover:text-blue-700">Change profile photo</button>
                </div>

                <!-- Input Fields -->
                <div class="space-y-4">
                    <div class="flex items-center">
                        <label for="edit-name" class="w-1/4 text-sm font-semibold text-gray-500">Name</label>
                        <input type="text" id="edit-name" class="w-3/4 p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Full Name">
                    </div>
                    <div class="flex items-center">
                        <label for="edit-username" class="w-1/4 text-sm font-semibold text-gray-500">Username</label>
                        <input type="text" id="edit-username" class="w-3/4 p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Username">
                    </div>
                    <div class="flex">
                        <label for="edit-bio" class="w-1/4 text-sm font-semibold text-gray-500 pt-2">Bio</label>
                        <textarea id="edit-bio" rows="3" class="w-3/4 p-2 border border-gray-300 rounded-lg resize-none focus:ring-blue-500 focus:border-blue-500" placeholder="Tell us about yourself..."></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create Post Modal -->
    <div id="create-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center modal-overlay" onclick="closeModal('create-modal')">
        <div class="bg-white p-6 rounded-xl shadow-2xl modal-content" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4 text-center border-b pb-2">Create New Post</h3>
            
            <div id="image-preview-container" class="h-64 w-full bg-gray-100 rounded-lg flex items-center justify-center mb-4 border-2 border-dashed border-gray-300">
                <img id="image-preview" src="" alt="Image Preview" class="hidden max-h-full max-w-full object-contain rounded-lg">
                <span id="upload-placeholder" class="text-gray-500 text-center">
                    <i data-lucide="image-plus" class="w-12 h-12 mb-2 inline-block"></i>
                    <p>Select image from device</p>
                </span>
            </div>
            
            <input type="file" id="post-image-input" accept="image/*" class="hidden" onchange="previewImage(event)">

            <button class="w-full bg-blue-500 text-white py-3 rounded-lg font-bold mb-4 hover:bg-blue-600 transition-colors" onclick="document.getElementById('post-image-input').click()">
                Select Image
            </button>

            <textarea id="post-caption-input" class="w-full h-20 p-3 border rounded-lg resize-none placeholder-gray-500" placeholder="Write a caption..."></textarea>
            
            <!-- New Story Checkbox -->
            <div class="flex items-center mt-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                <input type="checkbox" id="add-to-story" class="form-checkbox h-4 w-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                <label for="add-to-story" class="ml-3 text-sm font-medium text-gray-700">Add to Your Story</label>
            </div>

            <button id="share-post-btn" class="w-full bg-green-500 text-white py-3 rounded-lg font-bold mt-4 hover:bg-green-600 transition-colors disabled:opacity-50" disabled onclick="handleSharePost()">
                Share Post
            </button>

        </div>
    </div>

    <!-- Main Application Container -->
    <div class="app-container">

        <!-- === LEFT SIDEBAR / DESKTOP NAV === -->
        <aside class="sidebar p-3">
            <h1 class="text-3xl font-extrabold p-3 mt-4 mb-8">Social Media</h1>
            <nav class="space-y-2" id="desktop-nav">
                <!-- Links will have data-view attribute to control content -->
                <a href="#" data-view="feed" class="nav-link flex items-center p-3 rounded-xl font-bold text-gray-800 bg-gray-100"><i data-lucide="home" class="w-6 h-6 mr-3"></i> Home</a>
                <a href="#" data-view="search" class="nav-link flex items-center p-3 rounded-xl font-medium text-gray-600 hover:bg-gray-100"><i data-lucide="search" class="w-6 h-6 mr-3"></i> Search</a>
                <a href="#" data-view="messages" class="nav-link flex items-center p-3 rounded-xl font-medium text-gray-600 hover:bg-gray-100"><i data-lucide="send" class="w-6 h-6 mr-3"></i> Messages <span id="desktop-messages-badge"></span></a>
                <a href="#" data-view="notifications" class="nav-link flex items-center p-3 rounded-xl font-medium text-gray-600 hover:bg-gray-100"><i data-lucide="heart" class="w-6 h-6 mr-3"></i> Notifications</a>
                <a href="#" data-view="create" class="nav-link flex items-center p-3 rounded-xl font-medium text-gray-600 hover:bg-gray-100" onclick="openModal('create-modal'); return false;"><i data-lucide="plus-square" class="w-6 h-6 mr-3"></i> Create</a>
                <a href="#" data-view="profile" class="nav-link flex items-center p-3 rounded-xl font-medium text-gray-600 hover:bg-gray-100"><i data-lucide="user" class="w-6 h-6 mr-3"></i> Profile</a>
                <a href="#" class="nav-link flex items-center p-3 rounded-xl font-medium text-gray-600 hover:bg-gray-100 mt-12" onclick="openSettingsModal()"><i data-lucide="settings" class="w-6 h-6 mr-3"></i> Settings</a>
            </nav>
        </aside>

        <!-- === MAIN CONTENT AREA - DYNAMICALLY SWITCHED === -->
        <main class="main-content-area lg:pt-8 pt-2">
            
            <!-- Dynamic Content View Container -->
            <div id="content-container" class="content-view">
                <!-- Views are rendered here based on selected navigation link -->
            </div>
            
            <!-- RIGHT SIDE SUGGESTIONS PANEL (Only shown on the Feed View) -->
            <aside id="suggestions-panel" class="hidden lg:block w-[300px] ml-16 pt-8 sticky top-0 h-fit">
                <!-- Profile/Suggestions/Friend Requests (Content remains the same) -->
                <div class="flex items-center mb-6">
                    <div class="story-circle-border w-14 h-14 p-0.5 bg-gray-100">
                        <div class="story-circle w-12 h-12" style="background-image: url('${userProfile.profileImg}'); border: 2px solid white;"></div>
                    </div>
                    <div class="ml-4 flex-grow">
                        <span class="block font-bold text-sm text-gray-800">@${userProfile.username}</span>
                        <span class="block text-sm text-gray-500">${userProfile.name}</span>
                    </div>
                    <button class="text-blue-500 font-bold text-xs hover:text-blue-700">Switch</button>
                </div>

                <div class="flex justify-between items-center mb-3">
                    <p class="text-sm font-bold text-gray-500">Suggestions For You</p>
                    <a href="#" class="text-xs font-bold text-gray-800 hover:text-gray-500">See All</a>
                </div>
                
                <div class="flex items-center mb-3">
                    <div class="w-8 h-8 rounded-full bg-gray-300" style="background-image: url('https://i.pravatar.cc/150?img=18'); background-size: cover;"></div>
                    <div class="ml-4 flex-grow">
                        <span class="block font-semibold text-sm text-gray-800">friend_req_1</span>
                        <span class="block text-xs text-gray-500">Suggested for you</span>
                    </div>
                    <button class="text-blue-500 font-bold text-xs hover:text-blue-700 follow-btn" data-following="false" onclick="toggleFollow(this)">Follow</button>
                </div>

                <div class="flex items-center mb-3">
                    <div class="w-8 h-8 rounded-full bg-gray-300" style="background-image: url('https://i.pravatar.cc/150?img=22'); background-size: cover;"></div>
                    <div class="ml-4 flex-grow">
                        <span class="block font-semibold text-sm text-gray-800">new_coder</span>
                        <span class="block text-xs text-gray-500">New to InstaClone</span>
                    </div>
                    <button class="text-blue-500 font-bold text-xs hover:text-blue-700 follow-btn" data-following="false" onclick="toggleFollow(this)">Follow</button>
                </div>
                
                <div class="mt-8">
                    <p class="text-sm font-bold text-gray-500 mb-3">Friend Requests</p>
                    
                    <div class="flex items-center mb-3 p-2 bg-gray-100 rounded-lg">
                        <div class="w-10 h-10 rounded-full bg-gray-300" style="background-image: url('https://i.pravatar.cc/150?img=33'); background-size: cover;"></div>
                        <div class="ml-3 flex-grow">
                            <span class="block font-semibold text-sm text-gray-800">pending_user</span>
                            <span class="block text-xs text-gray-500">1 mutual friend</span>
                        </div>
                        <button class="text-white bg-blue-500 font-bold text-xs px-3 py-1 rounded-md mr-1 hover:bg-blue-600">Accept</button>
                        <button class="text-gray-700 bg-gray-300 font-bold text-xs px-3 py-1 rounded-md hover:bg-gray-400">Delete</button>
                    </div>
                </div>
            </aside>
        </main>

        <!-- === MOBILE BOTTOM NAVIGATION BAR === -->
        <nav class="mobile-nav fixed bottom-0 left-0 right-0 h-14 bg-white border-t border-gray-200 justify-around items-center shadow-lg hidden">
            <a href="#" data-view="feed" class="mobile-nav-link p-2"><i data-lucide="home" class="w-6 h-6 text-gray-800"></i></a>
            <a href="#" data-view="search" class="mobile-nav-link p-2"><i data-lucide="search" class="w-6 h-6 text-gray-600"></i></a>
            <a href="#" data-view="create" class="p-2" onclick="openModal('create-modal')"><i data-lucide="plus-square" class="w-6 h-6 text-gray-600"></i></a>
            <a href="#" data-view="messages" class="mobile-nav-link p-2 relative">
                <i data-lucide="send" class="w-6 h-6 text-gray-600"></i>
                <span id="mobile-messages-badge" class="absolute top-1 right-0 bg-red-500 w-2 h-2 rounded-full hidden"></span>
            </a>
            <a href="#" data-view="profile" class="mobile-nav-link p-2">
                <div class="w-7 h-7 rounded-full border-2 border-gray-600" style="background-image: url('${userProfile.profileImg}'); background-size: cover;"></div>
            </a>
        </nav>
    </div>

    <script>
        // --- STATE MANAGEMENT ---

        // Load or set default user profile from localStorage
        function loadUserProfile() {
            const defaultProfile = {
                username: 'krishagswm',
                name: 'Krishag Swami',
                bio: 'âœ¨ Tech Enthusiast | Web Developer | Coffee Lover â˜•',
                followerCount: '5.2k',
                followingCount: 340,
                profileImg: 'https://i.pravatar.cc/150?img=47'
            };
            try {
                const savedProfile = JSON.parse(localStorage.getItem('userProfile'));
                return savedProfile ? { ...defaultProfile, ...savedProfile } : defaultProfile;
            } catch (e) {
                console.error("Error loading profile settings, using default.", e);
                return defaultProfile;
            }
        }
        let userProfile = loadUserProfile();

        function saveUserProfile() {
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
        }

        let currentProfileTab = 'posts'; 

        // Load or set default privacy settings from localStorage
        function loadPrivacySettings() {
            const defaultSettings = {
                isPrivateAccount: false,
                showActivityStatus: true,
                allowCommentsFrom: 'everyone', // 'everyone', 'followers', 'no one'
            };
            try {
                const savedSettings = JSON.parse(localStorage.getItem('privacySettings'));
                return savedSettings ? { ...defaultSettings, ...savedSettings } : defaultSettings;
            } catch (e) {
                console.error("Error loading privacy settings, using default.", e);
                return defaultSettings;
            }
        }
        let privacySettings = loadPrivacySettings();

        function savePrivacySettings() {
            localStorage.setItem('privacySettings', JSON.stringify(privacySettings));
        }

        // --- MESSAGES STATE ---
        const chats = [
            { id: 1, user: "chatter_1", userImg: "https://i.pravatar.cc/150?img=5", lastMessage: "New message: Hey, how are you?", unseenCount: 3, messages: [
                { sender: "other", text: "Hey, how are you?" },
                { sender: "self", text: "I'm great, thanks! Working on a project." },
                { sender: "other", text: "Awesome! Let's connect soon." }
            ] },
            { id: 2, user: "old_friend", userImg: "https://i.pravatar.cc/150?img=9", lastMessage: "Sent 2h ago", unseenCount: 0, messages: [
                { sender: "other", text: "Did you see that new framework?" },
                { sender: "self", text: "Not yet, sending you the link now." },
                { sender: "other", text: "It's called 'NanoStack', check it out!" }
            ] },
            { id: 3, user: "team_project", userImg: "https://i.pravatar.cc/150?img=15", lastMessage: "Tagged you in a post.", unseenCount: 1, messages: [
                { sender: "other", text: "We finished the demo, check it out!" },
                { sender: "self", text: "Looks amazing, great work team!" }
            ] }
        ];

        let activeChatId = null; // State to track which chat is currently open

        function getTotalUnseenMessages() {
            return chats.reduce((total, chat) => total + chat.unseenCount, 0);
        }

        function renderMessageBadge(totalCount) {
            const desktopNav = document.getElementById('desktop-messages-badge');
            const mobileBadge = document.getElementById('mobile-messages-badge');

            if (totalCount > 0) {
                // Desktop: Show exact count
                const badgeHtml = `<span class="ml-auto bg-red-500 text-white text-xs font-semibold px-2 py-0.5 rounded-full">${totalCount}</span>`;
                if (desktopNav) desktopNav.innerHTML = badgeHtml;
                // Mobile: Show red dot
                if (mobileBadge) mobileBadge.classList.remove('hidden');
            } else {
                // Hide count/dot if zero
                if (desktopNav) desktopNav.innerHTML = '';
                if (mobileBadge) mobileBadge.classList.add('hidden');
            }
        }

        // --- DATA (Simulated Posts) ---
        let posts = [
            { id: 1, user: "pro_developer", userImg: "https://i.pravatar.cc/150?img=12", caption: "Just finished setting up my new dev environment! Ready to code! ðŸ’»", likes: 99, img: "https://placehold.co/600x600/6C63FF/ffffff?text=Hello+World", isSaved: false, isTagged: false },
            { id: 2, user: "sunset_chaser", userImg: "https://i.pravatar.cc/150?img=21", caption: "Chasing that perfect golden hour! ðŸŒ… #travel #codingbreak", likes: 2450, img: "https://placehold.co/600x600/FF6347/ffffff?text=Travel+Vibes", isSaved: true, isTagged: false },
            { id: 3, user: "community_hub", userImg: "https://i.pravatar.cc/150?img=17", caption: "Great meetup with the team! Tagged me in this one!", likes: 500, img: "https://placehold.co/600x600/3CB371/ffffff?text=Team+Event", isSaved: false, isTagged: true }
        ];
        
        // --- CORE UI FUNCTIONALITY ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            updateThemeDisplay();
            renderMessageBadge(getTotalUnseenMessages());
            
            // Set up navigation listeners
            document.querySelectorAll('.nav-link, .mobile-nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = link.getAttribute('data-view');
                    if (view !== 'create') {
                        navigateTo(view);
                    }
                    // For create, the modal is opened via an inline click handler
                });
            });

            // Initial view load
            navigateTo('feed');
        });

        // --- Routing Function ---
        function navigateTo(view) {
            const container = document.getElementById('content-container');
            const suggestionsPanel = document.getElementById('suggestions-panel');
            
            // 1. Update active link style
            document.querySelectorAll('.nav-link, .mobile-nav-link').forEach(link => {
                link.classList.remove('bg-gray-100', 'font-bold');
                link.classList.add('font-medium');
                if (link.getAttribute('data-view') === view) {
                    link.classList.add('bg-gray-100', 'font-bold');
                    link.classList.remove('font-medium');
                }
            });

            // 2. Hide suggestions panel unless on feed
            suggestionsPanel.classList.toggle('hidden', view !== 'feed');

            // 3. Render content based on view
            container.innerHTML = '';
            
            switch (view) {
                case 'feed':
                    renderFeed(container);
                    break;
                case 'messages':
                    // Reset activeChatId to null to ensure list is shown first, as requested
                    activeChatId = null;
                    renderMessages(container);
                    break;
                case 'profile':
                    // Pass the current tab to keep the state when navigating away and back
                    renderProfile(container, currentProfileTab); 
                    break;
                case 'search':
                    renderSearch(container);
                    break;
                case 'notifications':
                    renderNotifications(container);
                    break;
            }
            // Re-render icons after new HTML is added
            lucide.createIcons();
        }

        // --- View Renderers ---

        function renderFeed(container) {
            container.classList.remove('max-w-[900px]');
            container.classList.add('feed-wrapper', 'px-4', 'lg:px-0');

            container.innerHTML = `
                <!-- Stories Section (Keep for completeness) -->
                <section class="flex space-x-4 p-3 overflow-x-scroll bg-white dark:bg-zinc-800 border border-gray-200 dark:border-zinc-700 rounded-xl mb-6 shadow-sm">
                    <div class="flex-shrink-0 text-center text-xs font-medium w-[68px]">
                        <div class="story-circle-border bg-gray-100 dark:bg-zinc-800 p-0.5"><div class="story-circle" style="background-image: url('${userProfile.profileImg}'); border: 2px solid white;"></div></div>
                        <span class="truncate dark:text-gray-300">Your Story</span>
                    </div>
                    <div class="flex-shrink-0 text-center text-xs font-medium w-[68px]">
                        <div class="story-circle-border"><div class="story-circle" style="background-image: url('https://i.pravatar.cc/150?img=11');"></div></div>
                        <span class="truncate dark:text-gray-300">dev_friend</span>
                    </div>
                    <div class="flex-shrink-0 text-center text-xs font-medium w-[68px]">
                        <div class="story-circle-border"><div class="story-circle" style="background-image: url('https://i.pravatar.cc/150?img=17');"></div></div>
                        <span class="truncate dark:text-gray-300">coding_guy</span>
                    </div>
                    <div class="flex-shrink-0 text-center text-xs font-medium w-[68px]">
                        <div class="story-circle-border"><div class="story-circle" style="background-image: url('https://i.pravatar.cc/150?img=25');"></div></div>
                        <span class="truncate dark:text-gray-300">web_girl</span>
                    </div>
                </section>
                
                <!-- Posts Feed -->
                <section id="posts-feed-container">
                    ${posts.map(post => renderPostCard(post)).join('')}
                </section>
            `;
            lucide.createIcons();
        }
        
        function renderPostCard(post) {
            // Check if saved/liked state is true to set the initial icon style
            const savedFill = post.isSaved ? 'fill-gray-700 dark:fill-gray-300' : 'text-gray-700 dark:text-gray-300';
            const likedFill = post.isLiked ? 'fill-red-500 text-red-500' : 'text-gray-700 dark:text-gray-300';

            return `
                <article class="post-card" id="post-${post.id}">
                    <header class="flex justify-between items-center p-3 border-b border-gray-100 dark:border-zinc-700">
                        <div class="flex items-center">
                            <div class="story-circle-border w-10 h-10 p-0.5">
                                <div class="story-circle w-8 h-8" style="background-image: url('${post.userImg}'); border: 1px solid white;"></div>
                            </div>
                            <span class="font-bold text-sm ml-3">${post.user}</span>
                        </div>
                        <button class="text-xl font-bold text-gray-500">...</button>
                    </header>
                    
                    <img src="${post.img}" alt="Post" class="post-image">
                    
                    <div class="p-3">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex space-x-4">
                                <button class="action-icon" onclick="toggleLike(this, ${post.id})"><i data-lucide="heart" class="w-6 h-6 ${likedFill} hover:fill-red-500 hover:text-red-500 transition-colors"></i></button>
                                <button class="action-icon"><i data-lucide="message-circle" class="w-6 h-6 text-gray-700 dark:text-gray-300"></i></button>
                                <button class="action-icon"><i data-lucide="send" class="w-6 h-6 text-gray-700 dark:text-gray-300"></i></button>
                            </div>
                            <button class="action-icon" onclick="toggleSave(this, ${post.id})"><i data-lucide="bookmark" class="w-6 h-6 ${savedFill} hover:fill-gray-700 dark:hover:fill-gray-300 transition-colors"></i></button>
                        </div>
                        
                        <p class="font-semibold text-sm mb-1">${post.likes.toLocaleString()} Likes</p>
                        <p class="text-sm">
                            <span class="font-bold">${post.user}</span> ${post.caption}
                        </p>
                        <a href="#" class="text-xs text-gray-500 dark:text-gray-400 mt-1 block">View comments</a>
                    </div>
                </article>
            `;
        }
        
        // Helper function to render the list of chats
        function renderChatList(activeId) {
            return `
                <h3 class="font-semibold text-lg mb-4 p-2">Inbox</h3>
                <div class="space-y-3">
                ${chats.map(chat => {
                    const isUnseen = chat.unseenCount > 0;
                    const usernameClass = isUnseen ? 'font-extrabold text-gray-800 dark:text-white' : 'font-bold text-gray-800 dark:text-gray-300';
                    const lastMessageClass = isUnseen ? 'text-blue-500 font-semibold' : 'text-gray-500 dark:text-gray-400';
                    
                    return `
                        <div class="flex items-center p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer transition-colors 
                            ${chat.id === activeId ? 'bg-blue-50 dark:bg-blue-900/50 border-l-4 border-blue-500' : ''}" 
                            onclick="openChat(${chat.id})">
                            <div class="w-10 h-10 rounded-full flex-shrink-0" style="background-image: url('${chat.userImg}'); background-size: cover;"></div>
                            <div class="ml-3 overflow-hidden flex-grow">
                                <p class="${usernameClass} text-sm truncate">${chat.user}</p>
                                <p class="text-xs ${lastMessageClass} truncate">${chat.lastMessage}</p>
                            </div>
                            <!-- Unread badge/dot -->
                            ${isUnseen ? `<span class="w-2 h-2 bg-blue-500 rounded-full ml-2 flex-shrink-0"></span>` : ''}
                        </div>
                    `;
                }).join('')}
                </div>
                <div class="text-center pt-6 border-t dark:border-zinc-700 mt-4">
                    <button class="text-blue-500 font-semibold text-sm hover:text-blue-700">See all messages</button>
                </div>
            `;
        }

        // Helper function to render a single chat window
        function renderChatWindow(chat) {
            return `
                <header class="flex items-center p-4 border-b dark:border-zinc-700">
                    <button onclick="closeChat()" class="lg:hidden text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-zinc-700 rounded-full p-1 mr-2 flex-shrink-0">
                        <i data-lucide="chevron-left" class="w-6 h-6"></i>
                    </button>
                    <div class="w-10 h-10 rounded-full flex-shrink-0" style="background-image: url('${chat.userImg}'); background-size: cover;"></div>
                    <h3 class="font-bold text-lg ml-3 flex-grow">${chat.user}</h3>
                    <i data-lucide="info" class="w-6 h-6 text-gray-500 cursor-pointer hover:text-gray-700"></i>
                </header>
                <div class="flex-grow overflow-y-auto p-4 space-y-3 custom-scrollbar">
                    ${chat.messages.map(msg => `
                        <div class="flex ${msg.sender === 'self' ? 'justify-end' : 'justify-start'}">
                            <div class="${msg.sender === 'self' ? 'bg-blue-500 text-white' : 'bg-gray-200 dark:bg-zinc-700'} p-3 rounded-xl max-w-xs shadow-md">
                                ${msg.text}
                            </div>
                        </div>
                    `).join('')}
                    <!-- Placeholder for new message -->
                </div>
                <div class="border-t pt-3 p-4 dark:border-zinc-700 flex items-center">
                    <input type="text" placeholder="Message..." class="flex-grow p-3 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-zinc-700 dark:border-zinc-600">
                    <button class="ml-2 text-blue-500 font-bold hover:text-blue-700"><i data-lucide="send" class="w-6 h-6"></i></button>
                </div>
            `;
        }

        function renderMessages(container) {
            container.classList.remove('feed-wrapper', 'px-4', 'lg:px-0');
            container.classList.add('max-w-[900px]', 'w-full', 'mx-auto', 'p-4');
            
            const activeChat = chats.find(c => c.id === activeChatId);
            const isChatOpen = activeChatId !== null;

            let mainContent;

            if (!isChatOpen) {
                // List Only View (Default on tab click, or full screen on mobile)
                mainContent = `
                    <div class="w-full">
                        ${renderChatList(activeChatId)}
                    </div>
                `;
            } else {
                // Two-Pane View (Desktop) or Chat Window Only (Mobile)
                mainContent = `
                    <!-- Chat List Column (Hidden on mobile if chat is open) -->
                    <div class="w-full lg:w-1/3 border-r pr-4 space-y-3 dark:border-zinc-700 ${isChatOpen && activeChatId !== null ? 'hidden lg:block' : ''}">
                        ${renderChatList(activeChatId)}
                    </div>
                    
                    <!-- Chat Window Column (Full width on mobile, 2/3 on desktop) -->
                    <div class="w-full lg:w-2/3 flex flex-col h-[70vh] ${!isChatOpen ? 'hidden' : ''} ${isChatOpen && activeChatId !== null ? 'lg:pl-4' : 'lg:pl-0'}">
                        ${activeChat ? renderChatWindow(activeChat) : ''}
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="bg-white dark:bg-zinc-800 rounded-xl shadow-lg border border-gray-200 dark:border-zinc-700">
                    <h2 class="text-2xl font-bold p-4 border-b dark:border-zinc-700 ${isChatOpen ? 'hidden lg:block' : ''}">Messages (Direct)</h2>
                    <div class="p-0 lg:p-4 flex ${isChatOpen && activeChatId !== null ? 'flex-col' : 'lg:flex-row'}">
                        ${mainContent}
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function openChat(chatId) {
            activeChatId = chatId;
            const container = document.getElementById('content-container');
            
            // Mark chat as seen and update navigation badge
            const chatToOpen = chats.find(c => c.id === chatId);
            if (chatToOpen) {
                chatToOpen.unseenCount = 0; // Mark as seen
                renderMessageBadge(getTotalUnseenMessages());
            }

            renderMessages(container);
        }

        function closeChat() {
            activeChatId = null;
            const container = document.getElementById('content-container');
            renderMessages(container);
        }

        function renderProfile(container, activeTab = 'posts') {
            currentProfileTab = activeTab; // Update global state
            container.classList.remove('feed-wrapper', 'px-4', 'lg:px-0');
            container.classList.add('max-w-[900px]', 'w-full', 'mx-auto', 'p-4');

            const totalPosts = posts.length;
            const savedPosts = posts.filter(p => p.isSaved);
            const taggedPosts = posts.filter(p => p.isTagged);

            function renderPostGrid(data) {
                if (data.length === 0) {
                    return `
                        <div class="text-center py-10 text-gray-500 dark:text-gray-400">
                            <i data-lucide="camera-off" class="w-10 h-10 mx-auto mb-3"></i>
                            <p class="font-semibold">No posts here yet.</p>
                        </div>
                    `;
                }
                return `
                    <div class="grid grid-cols-3 gap-1 mt-1">
                        ${data.map(post => `
                            <div class="aspect-square bg-gray-200 dark:bg-zinc-700 overflow-hidden cursor-pointer hover:opacity-80 transition-opacity">
                                <img src="${post.img}" alt="Post" class="w-full h-full object-cover">
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            let gridContent = '';
            switch (currentProfileTab) {
                case 'saved':
                    gridContent = renderPostGrid(savedPosts);
                    break;
                case 'tagged':
                    gridContent = renderPostGrid(taggedPosts);
                    break;
                case 'posts':
                default:
                    gridContent = renderPostGrid(posts);
                    break;
            }


            container.innerHTML = `
                <div class="bg-white dark:bg-zinc-800 rounded-xl shadow-lg border border-gray-200 dark:border-zinc-700 p-6">
                    <!-- Profile Header -->
                    <header class="flex items-center space-x-10 pb-8 border-b dark:border-zinc-700">
                        <div class="w-32 h-32 rounded-full border-4 border-gray-300 flex-shrink-0" style="background-image: url('${userProfile.profileImg}'); background-size: cover;"></div>
                        <div>
                            <div class="flex items-center space-x-4 mb-2">
                                <h2 class="text-2xl font-light">@${userProfile.username}</h2>
                                <button class="bg-gray-200 dark:bg-zinc-700 text-gray-800 dark:text-gray-300 font-bold text-sm px-4 py-1.5 rounded-lg hover:bg-gray-300 transition-colors" onclick="openEditProfileModal()">Edit Profile</button>
                                <button class="text-gray-700 dark:text-gray-300"><i data-lucide="settings" class="w-6 h-6" onclick="openSettingsModal()"></i></button>
                            </div>
                            <div class="flex space-x-8 text-sm mb-4">
                                <span class="font-semibold">${totalPosts} <span class="font-normal text-gray-600 dark:text-gray-400">posts</span></span>
                                <span class="font-semibold">${userProfile.followerCount} <span class="font-normal text-gray-600 dark:text-gray-400">followers</span></span>
                                <span class="font-semibold">${userProfile.followingCount} <span class="font-normal text-gray-600 dark:text-gray-400">following</span></span>
                            </div>
                            <p class="font-bold">${userProfile.name}</p>
                            <p class="text-sm whitespace-pre-wrap">${userProfile.bio}</p>
                        </div>
                    </header>
                    
                    <!-- Posts Grid Tabs -->
                    <section class="mt-6">
                        <div class="flex justify-center border-t border-gray-200 dark:border-zinc-700">
                            <button onclick="renderProfile(document.getElementById('content-container'), 'posts')" class="profile-tab-button ${currentProfileTab === 'posts' ? 'active' : ''} flex items-center py-3 px-6 text-sm font-semibold -mt-px"><i data-lucide="layout-grid" class="w-5 h-5 mr-2"></i> POSTS</button>
                            <button onclick="renderProfile(document.getElementById('content-container'), 'saved')" class="profile-tab-button ${currentProfileTab === 'saved' ? 'active' : ''} flex items-center py-3 px-6 text-sm font-semibold -mt-px"><i data-lucide="bookmark" class="w-5 h-5 mr-2"></i> SAVED (${savedPosts.length})</button>
                            <button onclick="renderProfile(document.getElementById('content-container'), 'tagged')" class="profile-tab-button ${currentProfileTab === 'tagged' ? 'active' : ''} flex items-center py-3 px-6 text-sm font-semibold -mt-px"><i data-lucide="user-check" class="w-5 h-5 mr-2"></i> TAGGED (${taggedPosts.length})</button>
                        </div>
                        
                        <div id="profile-posts-grid-content">
                            ${gridContent}
                        </div>
                    </section>
                </div>
            `;
            lucide.createIcons();
        }

        function renderSearch(container) {
            container.classList.remove('feed-wrapper', 'px-4', 'lg:px-0');
            container.classList.add('max-w-[900px]', 'w-full', 'mx-auto', 'p-4');
            container.innerHTML = `
                <div class="bg-white dark:bg-zinc-800 rounded-xl shadow-lg border border-gray-200 dark:border-zinc-700 p-6">
                    <h2 class="text-2xl font-bold mb-4">Search & Explore</h2>
                    <div class="mb-6">
                        <input type="text" placeholder="Search accounts, tags, or places..." class="w-full p-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-zinc-700 dark:border-zinc-600">
                    </div>
                    
                    <h3 class="font-semibold text-lg mb-3">Discover Content</h3>
                    <div class="grid grid-cols-3 gap-1 aspect-[3/2]">
                        <div class="aspect-square bg-yellow-300 rounded-lg overflow-hidden row-span-2 col-span-2">
                             <img src="https://placehold.co/600x600/3A4F8B/ffffff?text=Trending+Post" alt="Trending" class="w-full h-full object-cover">
                        </div>
                        <div class="aspect-square bg-red-300 rounded-lg overflow-hidden">
                             <img src="https://placehold.co/300x300/F08080/ffffff?text=Art" alt="Art" class="w-full h-full object-cover">
                        </div>
                        <div class="aspect-square bg-green-300 rounded-lg overflow-hidden">
                             <img src="https://placehold.co/300x300/90EE90/ffffff?text=Nature" alt="Nature" class="w-full h-full object-cover">
                        </div>
                        <div class="aspect-square bg-purple-300 rounded-lg overflow-hidden col-span-1">
                            <img src="https://placehold.co/300x300/DDA0DD/ffffff?text=Code" alt="Code" class="w-full h-full object-cover">
                        </div>
                        <div class="aspect-square bg-orange-300 rounded-lg overflow-hidden col-span-2">
                            <img src="https://placehold.co/600x300/FFA07A/ffffff?text=Food+Blog" alt="Food" class="w-full h-full object-cover">
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function renderNotifications(container) {
             container.classList.remove('feed-wrapper', 'px-4', 'lg:px-0');
            container.classList.add('max-w-[900px]', 'w-full', 'mx-auto', 'p-4');
            container.innerHTML = `
                <div class="bg-white dark:bg-zinc-800 rounded-xl shadow-lg border border-gray-200 dark:border-zinc-700 p-6">
                    <h2 class="text-2xl font-bold mb-6">Notifications</h2>
                    <div class="space-y-4">
                        <div class="flex items-center p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-zinc-700 transition-colors">
                            <div class="w-10 h-10 rounded-full bg-red-400 flex-shrink-0" style="background-image: url('https://i.pravatar.cc/150?img=3'); background-size: cover;"></div>
                            <p class="ml-4 flex-grow text-sm"><span class="font-bold">user_liked</span> liked your post. <span class="text-gray-500 dark:text-gray-400 text-xs">2h ago</span></p>
                            <div class="w-12 h-12 bg-gray-200 dark:bg-zinc-700 flex-shrink-0"><img src="https://placehold.co/100x100/6C63FF/ffffff?text=Hello" class="w-full h-full object-cover"></div>
                        </div>
                         <div class="flex items-center p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-zinc-700 transition-colors">
                            <div class="w-10 h-10 rounded-full bg-blue-400 flex-shrink-0" style="background-image: url('https://i.pravatar.cc/150?img=1'); background-size: cover;"></div>
                            <p class="ml-4 flex-grow text-sm"><span class="font-bold">new_follower</span> started following you. <span class="text-gray-500 dark:text-gray-400 text-xs">5m ago</span></p>
                            <button class="bg-blue-500 text-white font-bold text-xs px-3 py-1.5 rounded-lg hover:bg-blue-600 flex-shrink-0">Follow Back</button>
                        </div>
                        <div class="flex items-center p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-zinc-700 transition-colors">
                            <div class="w-10 h-10 rounded-full bg-green-400 flex-shrink-0" style="background-image: url('https://i.pravatar.cc/150?img=19'); background-size: cover;"></div>
                            <p class="ml-4 flex-grow text-sm"><span class="font-bold">comment_guy</span> commented: "Nice shot!" <span class="text-gray-500 dark:text-gray-400 text-xs">1d ago</span></p>
                             <div class="w-12 h-12 bg-gray-200 dark:bg-zinc-700 flex-shrink-0"><img src="https://placehold.co/100x100/FF6347/ffffff?text=Travel" class="w-full h-full object-cover"></div>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        // --- POST CREATION AND MODAL LOGIC (UNCHANGED) ---

        let selectedImageFile = null;

        function previewImage(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('image-preview');
            const placeholder = document.getElementById('upload-placeholder');
            const shareBtn = document.getElementById('share-post-btn');

            if (file) {
                selectedImageFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                    shareBtn.disabled = false;
                }
                reader.readAsDataURL(file);
            } else {
                selectedImageFile = null;
                preview.classList.add('hidden');
                placeholder.classList.remove('hidden');
                shareBtn.disabled = true;
            }
            lucide.createIcons();
        }

        function handleSharePost() {
            if (!selectedImageFile) {
                console.error("No image selected.");
                return;
            }

            const caption = document.getElementById('post-caption-input').value || "";
            const isStory = document.getElementById('add-to-story').checked;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const newPost = {
                    id: Date.now(),
                    user: `@${userProfile.username}`,
                    userImg: userProfile.profileImg,
                    caption: caption,
                    likes: 0,
                    img: e.target.result,
                    isSaved: false,
                    isTagged: false 
                };

                if (isStory) {
                    console.log(`Story Shared! Image: ${selectedImageFile.name}`);
                }

                posts.unshift(newPost);
                
                closeModal('create-modal');
                navigateTo('feed');
                
                document.getElementById('post-caption-input').value = '';
                document.getElementById('add-to-story').checked = false;
                document.getElementById('image-preview').src = '';
                document.getElementById('image-preview').classList.add('hidden');
                document.getElementById('upload-placeholder').classList.remove('hidden');
                document.getElementById('share-post-btn').disabled = true;
                selectedImageFile = null;
                document.getElementById('post-image-input').value = ''; 
            }
            reader.readAsDataURL(selectedImageFile);
        }

        // --- PROFILE EDIT LOGIC ---

        function openEditProfileModal() {
            // Populate the input fields with current userProfile data
            document.getElementById('edit-name').value = userProfile.name;
            document.getElementById('edit-username').value = userProfile.username;
            document.getElementById('edit-bio').value = userProfile.bio;
            document.getElementById('profile-img-preview').style.backgroundImage = `url('${userProfile.profileImg}')`;

            openModal('edit-profile-modal');
            lucide.createIcons();
        }

        function saveProfileChanges() {
            const newName = document.getElementById('edit-name').value.trim();
            const newUsername = document.getElementById('edit-username').value.trim().toLowerCase().replace(/[^a-z0-9_.]/g, '');
            const newBio = document.getElementById('edit-bio').value.trim();

            if (!newName || !newUsername) {
                console.error("Name and Username cannot be empty.");
                // In a real app, show a message box to the user here.
                return;
            }

            // Update the global state
            userProfile.name = newName;
            userProfile.username = newUsername;
            userProfile.bio = newBio;
            
            // Persist to local storage
            saveUserProfile();

            // Close modal and re-render profile to show changes
            closeModal('edit-profile-modal');
            navigateTo('profile'); 
            console.log("Profile updated successfully!");
        }

        // --- SETTINGS AND PRIVACY LOGIC ---
        
        function openSettingsModal(view = 'main') {
            document.getElementById('settings-modal').classList.remove('hidden');
            renderSettingsModalContent(view);
        }

        function renderSettingsModalContent(view) {
            const container = document.getElementById('settings-modal-content');
            container.innerHTML = ''; 

            if (view === 'main') {
                container.innerHTML = `
                    <h3 class="text-xl font-bold mb-4 text-center border-b pb-2">Settings & Privacy</h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer transition-colors" onclick="toggleTheme()">
                            <span class="flex items-center"><i data-lucide="sun-moon" class="w-5 h-5 mr-3"></i> Theme: <span id="theme-status" class="ml-2 font-semibold text-blue-600">Light</span></span>
                        </div>
                        <div class="flex items-center p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer transition-colors" onclick="renderSettingsModalContent('privacy')">
                            <span class="flex items-center"><i data-lucide="lock" class="w-5 h-5 mr-3"></i> Privacy & Security</span>
                            <i data-lucide="chevron-right" class="w-5 h-5 ml-auto"></i>
                        </div>
                        <div class="flex items-center p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer transition-colors">
                            <i data-lucide="help-circle" class="w-5 h-5 mr-3"></i> Help & Support
                        </div>
                        <div class="flex items-center p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer transition-colors text-red-500 font-semibold">
                            <i data-lucide="log-out" class="w-5 h-5 mr-3"></i> Log Out
                        </div>
                    </div>
                    <button class="mt-4 w-full bg-gray-200 dark:bg-zinc-700 text-gray-700 dark:text-gray-300 py-2 rounded-lg font-medium hover:bg-gray-300 dark:hover:bg-zinc-600 transition-colors" onclick="closeModal('settings-modal')">Close</button>
                `;
            } else if (view === 'privacy') {
                renderPrivacySettings(container);
            }

            updateThemeDisplay();
            lucide.createIcons();
        }

        function renderPrivacySettings(container) {
            container.innerHTML = `
                <div class="flex items-center border-b pb-2 mb-4">
                    <button onclick="renderSettingsModalContent('main')" class="p-1 mr-3 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-zinc-700 rounded-full transition-colors"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                    <h3 class="text-xl font-bold text-center flex-grow">Privacy & Security</h3>
                </div>

                <div class="space-y-6">
                    <!-- Private Account Toggle -->
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-zinc-900 rounded-xl border border-gray-200 dark:border-zinc-700">
                        <div>
                            <p class="font-bold">Private Account</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Only approved followers can see your posts.</p>
                        </div>
                        <label class="toggle-switch relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="private-account-toggle" class="sr-only peer" ${privacySettings.isPrivateAccount ? 'checked' : ''} onchange="togglePrivacySetting('isPrivateAccount', this.checked)">
                            <div class="slider w-10 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600"></div>
                        </label>
                    </div>

                    <!-- Activity Status Toggle -->
                    <div class="flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-zinc-700 transition-colors">
                        <div>
                            <p class="font-bold">Show Activity Status</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Allow accounts you follow to see when you were last active.</p>
                        </div>
                        <label class="toggle-switch relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="activity-status-toggle" class="sr-only peer" ${privacySettings.showActivityStatus ? 'checked' : ''} onchange="togglePrivacySetting('showActivityStatus', this.checked)">
                            <div class="slider w-10 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600"></div>
                        </label>
                    </div>

                    <!-- Comment Controls (Radio Group) -->
                    <div class="p-3 border border-gray-200 dark:border-zinc-700 rounded-lg space-y-2">
                        <p class="font-bold mb-2">Allow Comments From</p>
                        ${['everyone', 'followers', 'no one'].map(option => `
                            <label class="flex items-center text-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-zinc-700 p-2 rounded-md">
                                <input type="radio" name="comment-control" value="${option}" 
                                    class="form-radio h-4 w-4 text-blue-600 border-gray-300"
                                    ${privacySettings.allowCommentsFrom === option ? 'checked' : ''}
                                    onclick="updateCommentControl('${option}')">
                                <span class="ml-3">${option.charAt(0).toUpperCase() + option.slice(1).replace('_', ' ')}</span>
                            </label>
                        `).join('')}
                    </div>

                    <div class="flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-zinc-700 cursor-pointer transition-colors">
                        <span class="flex items-center"><i data-lucide="bell-off" class="w-5 h-5 mr-3"></i> Hidden Words</span>
                        <i data-lucide="chevron-right" class="w-5 h-5 ml-auto"></i>
                    </div>
                </div>

                <button class="mt-4 w-full bg-gray-200 dark:bg-zinc-700 text-gray-700 dark:text-gray-300 py-2 rounded-lg font-medium hover:bg-gray-300 dark:hover:bg-zinc-600 transition-colors" onclick="closeModal('settings-modal')">Done</button>
            `;
            lucide.createIcons();
        }

        function togglePrivacySetting(key, isChecked) {
            privacySettings[key] = isChecked;
            savePrivacySettings();
            console.log(`Privacy Setting "${key}" updated to: ${isChecked}`);
        }

        function updateCommentControl(value) {
            privacySettings.allowCommentsFrom = value;
            savePrivacySettings();
            console.log(`Comment Control updated to: ${value}`);
        }

        // --- General Utilities ---
        
        function getPostById(id) {
            return posts.find(p => p.id === id);
        }

        function toggleLike(button, postId) {
            const icon = button.querySelector('i');
            const post = getPostById(postId);
            if (!post) return;

            post.isLiked = !post.isLiked;
            if (post.isLiked) {
                icon.classList.add('fill-red-500', 'text-red-500');
                icon.classList.remove('text-gray-700', 'dark:text-gray-300');
                post.likes += 1;
            } else {
                icon.classList.remove('fill-red-500', 'text-red-500');
                icon.classList.add('text-gray-700', 'dark:text-gray-300');
                post.likes -= 1;
            }
            navigateTo('feed');
        }
        
        function toggleSave(button, postId) {
            const icon = button.querySelector('i');
            const post = getPostById(postId);
            if (!post) return;

            post.isSaved = !post.isSaved;
            
            if (post.isSaved) {
                icon.classList.add('fill-gray-700', 'dark:fill-gray-300');
            } else {
                icon.classList.remove('fill-gray-700', 'dark:fill-gray-300');
            }
            if (currentProfileTab === 'saved') {
                 renderProfile(document.getElementById('content-container'), 'saved');
            }
        }

        function toggleFollow(button) {
            let isFollowing = button.getAttribute('data-following') === 'true';

            if (isFollowing) {
                button.textContent = 'Follow';
                button.classList.add('text-blue-500');
                button.classList.remove('text-gray-700');
                button.setAttribute('data-following', 'false');
            } else {
                button.textContent = 'Following';
                button.classList.remove('text-blue-500');
                button.classList.add('text-gray-700');
                button.setAttribute('data-following', 'true');
            }
        }

        function openModal(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
            if (id === 'create-modal') {
                document.getElementById('post-caption-input').value = '';
                document.getElementById('add-to-story').checked = false;
                document.getElementById('image-preview').src = '';
                document.getElementById('image-preview').classList.add('hidden');
                document.getElementById('upload-placeholder').classList.remove('hidden');
                document.getElementById('share-post-btn').disabled = true;
                selectedImageFile = null;
                document.getElementById('post-image-input').value = ''; 
            }
        }

        function toggleTheme() {
            const body = document.body;
            const themeStatus = document.getElementById('theme-status');
            
            if (body.classList.contains('dark')) {
                body.classList.remove('dark');
                body.classList.add('bg-gray-50');
                themeStatus.textContent = 'Light';
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.add('dark');
                body.classList.remove('bg-gray-50');
                themeStatus.textContent = 'Dark';
                localStorage.setItem('theme', 'dark');
            }
             // Re-render the modal to ensure icon colors update immediately
            renderSettingsModalContent('main');
        }

        function updateThemeDisplay() {
            const body = document.body;
            const themeStatus = document.getElementById('theme-status');
            const savedTheme = localStorage.getItem('theme') || 'light';

            if (savedTheme === 'dark') {
                body.classList.add('dark');
                body.classList.remove('bg-gray-50');
                if (themeStatus) themeStatus.textContent = 'Dark';
            } else {
                body.classList.remove('dark');
                body.classList.add('bg-gray-50');
                if (themeStatus) themeStatus.textContent = 'Light';
            }
        }
        
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'ig-blue': '#0095f6',
                        'ig-gray': '#dbdbdb',
                        'ig-dark-bg': '#121212',
                        'ig-dark-card': '#1e1e1e',
                    }
                }
            }
        }
    </script>

</body>
</html>
